server {
    listen 8080;

    # רק /profile ו/ (הנתיב הראשי) מועבר ל־Node server ומוכנס ל-cache
    location / {
        proxy_pass http://host.docker.internal:3000;

        # שליחת X-Forwarded-Host כמו שהוא הגיע מהלקוח (ללא החלפה)
        proxy_set_header X-Forwarded-Host $http_x_forwarded_host;
        proxy_set_header Host localhost:3000;

        # Cache setup
        proxy_cache my_cache;
        proxy_cache_valid 200 302 100s;

        # מפתח cache: לא כולל את X-Forwarded-Host
        proxy_cache_key $scheme$proxy_host$uri$is_args$args;

        # להראות אם הבקשה הגיעה מה-cache
        add_header X-Cache $upstream_cache_status;
    }

    # בקשות ל-/login לא ייכנסו ל-cache
    location /login {
        proxy_pass http://host.docker.internal:3000/login;
        proxy_set_header Host $host;
    }

    # בקשות ל-/evil-login לא ייכנסו ל-cache
    location /evil-login {
        proxy_pass http://host.docker.internal:3000/evil-login;
        proxy_set_header Host $host;
    }
}

# הגדרת cache path בסיסית
proxy_cache_path /tmp/cache levels=1:2 keys_zone=my_cache:10m max_size=100m inactive=60m use_temp_path=off;
